import{r,j as e}from"./ui-vendor-rA8IexKS.js";import{u as z,m as F,B as u,L as D,I as w,a as G,h as H}from"./index-hSqt8rb2.js";import{C as J}from"./ChatInterface-DZleLnGr.js";import{D as U,h as V,a as q,b as K,c as _}from"./index-DHJEQtTr.js";import{S as Q,a as W,b as X,c as Y,d as Z}from"./select-CtZYfv8r.js";import{O as ee,k as te,a8 as I,D as se,a9 as ae,T as re,aa as ie,A as le}from"./lucide-vendor-DI6dXaZX.js";import"./react-vendor-gH-7aFTg.js";import"./markdown-vendor-B8FCJfI7.js";function ne({transcriptionId:g,activeSessionId:l,onSessionChange:a}){const{getAuthHeaders:o}=z(),{subscribeSessionTitleUpdated:f,subscribeTitleGenerating:p}=F(),[h,n]=r.useState([]),[y,d]=r.useState([]),[x,j]=r.useState(""),[P,N]=r.useState(!1),[k,S]=r.useState(""),[A,v]=r.useState(null),[b,T]=r.useState(""),[M,$]=r.useState(new Set);r.useEffect(()=>{L(),O()},[g]),r.useEffect(()=>f(({sessionId:s,title:i})=>{n(m=>m.map(c=>c.id===s?{...c,title:i}:c))}),[f]),r.useEffect(()=>p(({sessionId:s,isGenerating:i})=>{$(m=>{const c=new Set(m);return i?c.add(s):c.delete(s),c})}),[p]);async function L(){try{const t=await fetch("/api/v1/chat/models",{headers:o()});if(!t.ok)return;const s=await t.json();d(s.models||[]),!x&&s.models?.length&&j(s.models[0])}catch{}}async function O(){try{const t=await fetch(`/api/v1/chat/transcriptions/${g}/sessions`,{headers:o()});if(!t.ok)return;const s=await t.json();n(s||[])}catch{}}async function B(){if(x)try{const t=await fetch("/api/v1/chat/sessions",{method:"POST",headers:{...o(),"Content-Type":"application/json"},body:JSON.stringify({transcription_id:g,model:x,title:k||void 0})});if(!t.ok)return;const s=await t.json();n(i=>[s,...i]),a(s.id),N(!1),S("")}catch{}}async function C(t,s){try{const i=await fetch(`/api/v1/chat/sessions/${t}/title`,{method:"PUT",headers:{...o(),"Content-Type":"application/json"},body:JSON.stringify({title:s})});if(!i.ok)return;const m=await i.json();n(c=>c.map(E=>E.id===t?m:E)),v(null)}catch{}}async function R(t){if(confirm("Delete this chat session?"))try{if(!(await fetch(`/api/v1/chat/sessions/${t}`,{method:"DELETE",headers:o()})).ok)return;const i=h.filter(m=>m.id!==t);n(i),l===t&&(i.length>0?a(i[0].id):a(null))}catch{}}return e.jsxs("div",{className:"h-full flex flex-col bg-gray-50 dark:bg-gray-850",children:[e.jsxs("div",{className:"flex-shrink-0 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:"Chats"}),e.jsxs(U,{open:P,onOpenChange:N,children:[e.jsx(V,{asChild:!0,children:e.jsx(u,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 hover:bg-gray-200 dark:hover:bg-gray-800",title:"New Chat",children:e.jsx(ee,{className:"h-4 w-4"})})}),e.jsxs(q,{className:"sm:max-w-[425px] bg-white dark:bg-gray-800 shadow-2xl",children:[e.jsx(K,{children:e.jsx(_,{children:"New Chat Session"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"model",children:"Model"}),e.jsxs(Q,{value:x,onValueChange:j,children:[e.jsx(W,{className:"w-full bg-white dark:bg-gray-800 border-0 text-foreground",children:e.jsx(X,{placeholder:"Select a model"})}),e.jsx(Y,{className:"bg-white dark:bg-gray-850 border-0",children:(y||[]).map(t=>e.jsx(Z,{value:t,children:t},t))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"title",children:"Title (optional)"}),e.jsx(w,{id:"title",value:k,onChange:t=>S(t.target.value),placeholder:"Enter a title..."})]}),e.jsx(u,{onClick:B,className:"w-full",children:"Create Session"})]})]})]})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(te,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(w,{placeholder:"Search conversations...",className:"pl-10 bg-white dark:bg-gray-800 border-0 text-sm",disabled:!0})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto px-2 pb-4",children:h.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-gray-500 dark:text-gray-400",children:[e.jsx(I,{className:"h-12 w-12 mb-4 text-gray-300 dark:text-gray-600"}),e.jsxs("div",{className:"text-sm text-center",children:[e.jsx("p",{className:"font-medium",children:"No conversations yet"}),e.jsx("p",{className:"mt-1 text-xs",children:"Start a new chat to begin!"})]})]}):e.jsx("div",{className:"space-y-1",children:h.map(t=>e.jsxs("div",{className:`group relative flex items-center p-2 mx-2 rounded-lg cursor-pointer transition-all duration-150 ${l===t.id?"bg-gray-200 dark:bg-gray-800":"hover:bg-gray-100 dark:hover:bg-gray-800"}`,onClick:()=>a(t.id),children:[e.jsx("div",{className:"flex-shrink-0 mr-3",children:e.jsx(I,{className:"h-4 w-4 text-gray-400 dark:text-gray-500"})}),e.jsx("div",{className:"flex-1 min-w-0 flex items-center",children:A===t.id?e.jsx(w,{value:b,onChange:s=>T(s.target.value),onKeyDown:s=>{s.key==="Enter"&&C(t.id,b),s.key==="Escape"&&v(null)},onBlur:()=>C(t.id,b),className:"h-6 text-sm bg-white dark:bg-gray-900 border-0 p-0 focus-visible:ring-0",autoFocus:!0}):e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsx("div",{className:"truncate text-sm text-gray-900 dark:text-gray-100 font-medium",children:t.title||"New Chat"}),M.has(t.id)&&e.jsx("div",{className:"flex-shrink-0 text-blue-500 dark:text-blue-400",title:"Generating title...",children:e.jsx(se,{className:"h-3 w-3 animate-pulse"})})]})}),e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(u,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded",onClick:s=>{s.stopPropagation(),v(t.id),T(t.title)},title:"Rename chat",children:e.jsx(ae,{className:"h-3 w-3"})}),e.jsx(u,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-400 hover:text-red-500 rounded",onClick:s=>{s.stopPropagation(),R(t.id)},title:"Delete chat",children:e.jsx(re,{className:"h-3 w-3"})})]})]},t.id))})})]})}function fe(){const{currentRoute:g,navigate:l}=G(),a=g.params?.audioId,o=g.params?.sessionId,{getAuthHeaders:f}=z(),[p,h]=r.useState(null),[n,y]=r.useState(!0);return r.useEffect(()=>{a||l({path:"home"})},[a,l]),r.useEffect(()=>{if(!a)return;(async()=>{try{const x=await fetch(`/api/v1/transcription/${a}`,{headers:f()});if(x.ok){const j=await x.json();h(j?.title||null)}else h(null)}catch{h(null)}})()},[a,f]),a?e.jsxs("div",{className:"text-gray-700 dark:text-gray-100 bg-white dark:bg-gray-900 h-screen max-h-[100dvh] overflow-auto flex flex-row justify-end",children:[n&&e.jsx("div",{className:"fixed inset-y-0 left-0 z-40 w-80 bg-white dark:bg-gray-850 md:relative md:translate-x-0",children:e.jsx(ne,{transcriptionId:a,activeSessionId:o,onSessionChange:d=>{l(d?{path:"chat",params:{audioId:a,sessionId:d}}:{path:"audio-detail",params:{id:a}})}})}),n&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden",onClick:()=>y(!1)}),e.jsxs("div",{className:`transition-width duration-200 ease-in-out ${n?"md:max-w-[calc(100%-320px)]":""} w-full max-w-full flex flex-col`,children:[e.jsxs("div",{className:"h-14 bg-white dark:bg-gray-900 flex items-center px-4 md:px-6 z-10",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>y(!n),className:"p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100",title:"Toggle Sidebar",children:e.jsx(ie,{className:"h-4 w-4"})}),e.jsxs(u,{variant:"ghost",size:"sm",onClick:()=>l({path:"audio-detail",params:{id:a}}),className:"gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100",children:[e.jsx(le,{className:"h-4 w-4"}),"Back to Transcript"]}),e.jsx("div",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 truncate",children:p||"Chat Session"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(H,{})})]}),e.jsx("div",{className:"flex-1 h-0 bg-white dark:bg-gray-900",children:e.jsx(J,{transcriptionId:a,activeSessionId:o,hideSidebar:!0,onSessionChange:d=>{l(d?{path:"chat",params:{audioId:a,sessionId:d}}:{path:"chat",params:{audioId:a}})}})})]})]}):null}export{fe as ChatPage};
