import{r,j as e}from"./ui-vendor-rA8IexKS.js";import{u as se,m as te,g as ae,B as T,I as re}from"./index-hSqt8rb2.js";import{i as G,t as D,R as ne,_,ab as le,C as oe}from"./lucide-vendor-DI6dXaZX.js";import{M as ie,r as ce,a as de,b as xe,c as me}from"./markdown-vendor-B8FCJfI7.js";const pe=r.memo(function({transcriptionId:j,activeSessionId:i,onSessionChange:R}){const{getAuthHeaders:h}=se(),{emitSessionTitleUpdated:z,emitTitleGenerating:A}=te(),{toast:O}=ae(),[K,g]=r.useState([]),[o,y]=r.useState(null),[E,d]=r.useState([]),[b,B]=r.useState(""),[v,F]=r.useState(!1),[q,I]=r.useState(""),[L,U]=r.useState("gpt-3.5-turbo"),[N,u]=r.useState(null),P=r.useRef(null),M=r.useRef(null),V=r.useRef(null),J=r.useCallback(()=>{const s=M.current;s?s.scrollTo({top:s.scrollHeight,behavior:"smooth"}):P.current?.scrollIntoView({behavior:"smooth"})},[]);r.useEffect(()=>{const s=M.current;if(!s)return;s.scrollHeight-(s.scrollTop+s.clientHeight)<120&&J()},[E,q]),r.useEffect(()=>{j&&W()},[j]);const k=r.useCallback(async s=>{try{d([]);const t=await fetch(`/api/v1/chat/sessions/${s}`,{headers:h()});if(!t.ok){const c=await t.json();throw new Error(c.error||"Failed to load chat session")}const n=await t.json();d(n.messages||[])}catch(t){console.error("Error loading chat session:",t),u(t.message),d([])}},[h]),H=r.useCallback(async()=>{try{const s=await fetch(`/api/v1/chat/transcriptions/${j}/sessions`,{headers:h()});if(!s.ok){const n=await s.json();throw new Error(n.error||"Failed to load chat sessions")}const t=await s.json();if(g(t||[]),t&&t.length>0)if(i){const n=t.find(c=>c.id===i);n&&(y(n),k(n.id))}else o||(y(t[0]),k(t[0].id),R?.(t[0].id))}catch(s){console.error("Error loading chat sessions:",s),s.message.includes("OpenAI")||u(s.message),g([])}},[j,h,i,o,R]);r.useEffect(()=>{if(!i||o?.id===i)return;const s=K.find(t=>t.id===i);s?(y(s),k(s.id)):(y(null),d([]),k(i),H())},[i,o?.id]);const W=async()=>{try{const s=await fetch("/api/v1/chat/models",{headers:h()});if(!s.ok){const n=await s.json();throw new Error(n.error||"Failed to load models")}const t=await s.json();t.models&&t.models.length>0&&!L&&U(t.models[0]),u(null),H()}catch(s){console.error("Error loading chat models:",s),u(s.message),g([])}},$=async()=>{if(!o||!b.trim()||v)return;const s=b.trim();B(""),F(!0),u(null);try{const t={id:Date.now(),role:"user",content:s,created_at:new Date().toISOString()};d(a=>[...a,t]);const n=await fetch(`/api/v1/chat/sessions/${o.id}/messages`,{method:"POST",headers:{...h(),"Content-Type":"application/json"},body:JSON.stringify({content:`${s}

Typeset all your answers in markdown and provide the markdown formatted string. Write equations in latex. Your response should contain only the markdown formatted string - nothing else. DO NOT wrap your response in code blocks, backticks, or any other formatting - return the raw markdown content directly.`})});if(!n.ok){const a=await n.json();throw new Error(a.error||"Failed to send message")}const c=n.body?.getReader();if(!c)throw new Error("No response body");let p="";I("");const C={id:Date.now()+1,role:"assistant",content:"",created_at:new Date().toISOString()};let w=-1;for(d(a=>(w=a.length,[...a,C]));;){const{done:a,value:x}=await c.read();if(a)break;const l=new TextDecoder().decode(x);p+=l,d(f=>{const m=[...f];return w>=0&&w<m.length&&(m[w]={...m[w],content:p}),m})}const X=p,S=[...E,t,{...C,content:X}],Z=S.filter(a=>a.role==="user").length,ee=S.filter(a=>a.role==="assistant").length;Z===2&&ee===2&&setTimeout(async()=>{const a=o?.id||i;if(a){A({sessionId:a,isGenerating:!0});try{const x=await fetch(`/api/v1/chat/sessions/${a}/title/auto`,{method:"POST",headers:{...h()}});if(x.ok){const l=await x.json();g(f=>f.map(m=>m.id===l.id?{...m,title:l.title}:m)),(o&&o.id===l.id||!o&&a===l.id)&&y(f=>f&&{...f,title:l.title}),O({title:"âœ¨ Chat Renamed",description:`Renamed to "${l.title}"`}),z({sessionId:l.id,title:l.title})}}catch(x){console.error("Error generating title:",x),O({title:"Failed to generate title",description:"Could not auto-generate chat title"})}finally{A({sessionId:a,isGenerating:!1})}}},500);try{const a=o?.id||i;a&&g(x=>x.map(l=>l.id===a?{...l,message_count:S.length,updated_at:new Date().toISOString()}:l))}catch(a){console.error("Error updating session metadata:",a)}}catch(t){console.error("Error sending message:",t),u(t.message),d(n=>n.slice(0,-1))}finally{F(!1),I("")}},Y=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),$())},Q=s=>{const t=r.useRef(null),[n,c]=r.useState(!1),p=async()=>{try{const C=t.current?.innerText||"";await navigator.clipboard.writeText(C),c(!0),setTimeout(()=>c(!1),1200)}catch{}};return e.jsxs("div",{className:"relative group",children:[e.jsxs("button",{onClick:p,className:"absolute right-2 top-2 inline-flex items-center gap-1 rounded-md px-2 py-1 text-xs bg-black/60 dark:bg-white/10 text-white dark:text-gray-200 hover:bg-black/70 dark:hover:bg-white/20 transition-opacity opacity-0 group-hover:opacity-100","aria-label":"Copy code",children:[n?e.jsx(oe,{className:"h-3 w-3"}):e.jsx(D,{className:"h-3 w-3"}),n?"Copied":"Copy"]}),e.jsx("pre",{ref:t,className:s.className,children:s.children})]})};return N&&N.includes("OpenAI")?e.jsxs("div",{className:"h-full flex flex-col items-center justify-center p-6",children:[e.jsx(G,{className:"h-16 w-16 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"OpenAI Configuration Required"}),e.jsx("p",{className:"text-sm text-muted-foreground text-center mb-4",children:"To use the chat feature, please configure your OpenAI API key in Settings."}),e.jsx(T,{onClick:()=>window.location.href="/settings",children:"Go to Settings"})]}):e.jsxs("div",{className:"h-full flex flex-col bg-white dark:bg-gray-900",children:[o||i?e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:M,className:"flex-1 overflow-y-auto pb-2.5 flex flex-col justify-between w-full flex-auto max-w-full z-10",id:"messages-container",children:e.jsxs("div",{className:"h-full w-full flex flex-col px-6 py-6 space-y-6",children:[(E||[]).map(s=>e.jsx("div",{className:"group w-full",children:s.role==="user"?e.jsx("div",{className:"flex justify-end",children:e.jsx("div",{className:"flex w-full max-w-5xl px-6 mx-auto",children:e.jsx("div",{className:"w-full flex justify-end",children:e.jsxs("div",{className:"flex space-x-3 max-w-3xl",children:[e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white rounded-2xl px-4 py-3 relative",children:[e.jsx("button",{onClick:async()=>{try{await navigator.clipboard.writeText(s.content||"")}catch{}},className:"absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-600",title:"Copy message",children:e.jsx(D,{className:"h-3 w-3"})}),e.jsx("div",{className:"text-sm leading-relaxed pr-6",children:s.content})]})}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-gray-300 dark:bg-gray-700 flex items-center justify-center flex-shrink-0",children:e.jsx(ne,{className:"h-4 w-4 text-gray-700 dark:text-white"})})]})})})}):e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"flex w-full max-w-5xl px-6 mx-auto",children:e.jsx("div",{className:"w-full flex justify-start",children:e.jsxs("div",{className:"flex space-x-3 max-w-5xl w-full",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center flex-shrink-0",children:e.jsx(_,{className:"h-4 w-4 text-gray-700 dark:text-gray-200"})}),e.jsxs("div",{className:"flex-1 space-y-2 overflow-hidden",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("div",{className:"font-medium text-gray-800 dark:text-gray-100 text-sm",children:"Assistant"})}),e.jsxs("div",{className:"prose prose-sm dark:prose-invert max-w-none text-gray-700 dark:text-gray-200 leading-relaxed",children:[e.jsx("button",{onClick:async()=>{try{await navigator.clipboard.writeText(s.content||"")}catch{}},className:"float-right opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800 ml-2",title:"Copy message",children:e.jsx(D,{className:"h-3 w-3"})}),e.jsx(ie,{remarkPlugins:[me],rehypePlugins:[ce,de,xe],components:{pre:Q},children:s.content})]})]})]})})})})},s.id)),v&&e.jsx("div",{className:"group w-full",children:e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"flex w-full max-w-5xl px-6 mx-auto",children:e.jsx("div",{className:"w-full flex justify-start",children:e.jsxs("div",{className:"flex space-x-3 max-w-5xl w-full",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center flex-shrink-0",children:e.jsx(_,{className:"h-4 w-4 text-gray-700 dark:text-gray-200"})}),e.jsxs("div",{className:"flex-1 space-y-2 overflow-hidden",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("div",{className:"font-medium text-gray-800 dark:text-gray-100 text-sm",children:"Assistant"})}),e.jsxs("div",{className:"flex items-center space-x-2 text-gray-500 dark:text-gray-400",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-current rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-current rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-current rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsx("span",{className:"text-sm",children:"Generating response..."})]})]})]})})})})}),e.jsx("div",{ref:P})]})}),e.jsx("div",{className:"pb-2",children:e.jsx("div",{className:"flex w-full max-w-5xl px-6 mx-auto",children:e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex items-end gap-3 bg-gray-50 dark:bg-gray-800 rounded-2xl p-3 mx-auto",children:[e.jsx(re,{ref:V,value:b,onChange:s=>B(s.target.value),onKeyDown:Y,placeholder:"Send a message...",disabled:v,className:"flex-1 border-0 bg-transparent focus-visible:ring-0 focus:ring-0 outline-none resize-none text-sm placeholder:text-gray-500 dark:placeholder:text-gray-400"}),e.jsx(T,{onClick:$,disabled:v||!b.trim(),size:"sm",className:"h-8 w-8 p-0 rounded-full bg-gray-900 hover:bg-gray-800 dark:bg-gray-100 dark:hover:bg-gray-200 text-white dark:text-gray-900",children:e.jsx(le,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2 px-2",children:"AI can make mistakes. Verify important information."})]})})})]}):e.jsx("div",{className:"flex items-center h-full",children:e.jsxs("div",{className:"flex flex-col items-center justify-center w-full max-w-md mx-auto p-6 text-center",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mb-4",children:e.jsx(G,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2",children:"How can I help you today?"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 max-w-sm",children:"Start a conversation about this transcript or ask any questions you have."})]})}),N&&e.jsxs("div",{className:"absolute bottom-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-lg max-w-sm",children:[e.jsx("p",{className:"text-sm",children:N}),e.jsx(T,{size:"sm",variant:"ghost",onClick:()=>u(null),className:"mt-2 text-white hover:bg-red-600",children:"Dismiss"})]})]})});export{pe as C};
